{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href="{% static 'css/nv.d3.min.css' %}" rel="stylesheet" type="text/css">
    <script src="{% static 'js/d3.min.js' %}" charset="utf-8"></script>
    <script src="{% static 'js/nv.d3.min.js' %}"></script>
    <title>Temperature Log</title>
    
    <style>
        p, text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        html, body, #chart1, svg {
            margin: 0px;
            padding: 0px;
            height: 95%;
            width: 100%;
        }
        #chartZoom {
            position: absolute;
            top: 0;
            left: 0;
        }
        .thermostat {
            stroke-dasharray: 5,5;
        }
        .reading {
            /* */
        }

        /* Pagination */
        #pages {
            padding-left: 20px;
        }

        a.week{
            padding-right: 10px;
            text-decoration: none;
            color: cornflowerblue;
        }

        a.week.strong{
            font-weight: bolder;
        }
    </style>
</head>
<body>

<div id="chart1" class='with-transitions'>
    <svg></svg>
</div>

{% if weeks.max %}
<div id="pages">
    <p>
        <a 
            href="" 
            class="
                week
            {% if weeks.ago == 0 %}
                strong
            {% endif %}
            ">This week </a>
        {% for week in weeks.max %}
            <a 
                href=""
                class="
                    week
                {% if week == weeks.ago %}
                    strong
                {% endif %}
                ">-{{ week }}</a>
        {% endfor %}
    </p>
</div>
{% endif %}

<script>
    var chart = nv.models.lineChart();
    var canvas = d3.select('#chart1 svg');
    var graph_data = [];

    function DrawGraph(){
        nv.addGraph(function() {
            chart.margin({left: 100})  //Adjust chart margins to give the x-axis some breathing room.
                 .useInteractiveGuideline(true)  //We want nice looking tooltips and a guideline!
                 .showLegend(true)       //Show the legend, allowing users to turn on/off line series.
                 .showYAxis(true)        //Show the y-axis
                 .showXAxis(true)        //Show the x-axis
                 .interpolate("step-before") 
                 .forceY([0, 30])
                ;
            
            chart.xAxis
                .ticks(7)
                .tickFormat(function(d) { 
                    return d3.time.format('%a %b %d %H:%M')(new Date(d));
                })

            chart.yAxis
                .axisLabel('Temperature (°C)')
                .ticks(10)
                .tickFormat(function(d) { 
                    return d.toFixed(2) + "°C";
                });
    
            nv.utils.windowResize(chart.update);
            return chart;
        });
    }

    function UpdateGraph(data){
            // Tidy up iso to js-date
        data.forEach(datum => {
            datum.values.forEach(val => {
                val.x = new Date(val.x);
            })
            graph_data.push(datum);
        })
        
        canvas.datum(graph_data).transition().duration(500).call(chart);
        nv.utils.windowResize(chart.update);
    }

    DrawGraph();
    d3.json("/log/get", UpdateGraph);
    d3.json("/thermostat/events", UpdateGraph);
</script>
</body>
</html>
